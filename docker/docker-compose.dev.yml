# Development Docker Compose configuration
# Usage: docker compose -f docker/docker-compose.dev.yml up
#
# This provides a complete local development environment with:
# - PostgreSQL database
# - Redis for job queues
# - Discord bot with hot-reload
# - Next.js web app with hot-reload
# - Cloudflare Tunnel for OAuth development (optional)
#
# Prerequisites:
# - Copy .env.example to .env and configure credentials
# - For tunnel: run `cloudflared tunnel login` and create tunnel first
#   See docs/TUNNEL_SETUP.md for details
#
# Profiles:
# - Default (no profile): postgres, redis, bot, web
# - With tunnel: docker compose -f docker/docker-compose.dev.yml --profile tunnel up

services:
  # ===================
  # Infrastructure
  # ===================

  postgres:
    image: postgres:15-alpine
    container_name: fightrise-postgres
    environment:
      POSTGRES_USER: fightrise
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword}
      POSTGRES_DB: fightrise
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fightrise"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: fightrise-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===================
  # Applications
  # ===================

  bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile.bot
      target: dev
    container_name: fightrise-bot
    environment:
      DATABASE_URL: postgresql://fightrise:${DB_PASSWORD:-devpassword}@postgres:5432/fightrise
      REDIS_URL: redis://redis:6379
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      STARTGG_API_KEY: ${STARTGG_API_KEY}
      # Smoke test environment variables (optional - tests will skip if not set)
      SMOKE_DISCORD_TOKEN: ${SMOKE_DISCORD_TOKEN}
      SMOKE_STARTGG_API_KEY: ${SMOKE_STARTGG_API_KEY}
      SMOKE_DISCORD_GUILD_ID: ${SMOKE_DISCORD_GUILD_ID}
      SMOKE_DISCORD_CHANNEL_ID: ${SMOKE_DISCORD_CHANNEL_ID}
      SMOKE_DISCORD_CLIENT_ID: ${SMOKE_DISCORD_CLIENT_ID}
      SMOKE_DISCORD_CLIENT_SECRET: ${SMOKE_DISCORD_CLIENT_SECRET}
      SMOKE_STARTGG_TOURNAMENT_SLUG: ${SMOKE_STARTGG_TOURNAMENT_SLUG}
    volumes:
      # Mount source code for hot-reload
      - ../apps/bot/src:/app/apps/bot/src
      - ../packages/shared/src:/app/packages/shared/src
      - ../packages/startgg-client/src:/app/packages/startgg-client/src
      - ../packages/database/src:/app/packages/database/src
      # Mount test configs for smoke, integration, and e2e tests
      - ../apps/bot/vitest.smoke.config.ts:/app/apps/bot/vitest.smoke.config.ts:ro
      - ../apps/bot/vitest.integration.config.ts:/app/apps/bot/vitest.integration.config.ts:ro
      - ../apps/bot/vitest.e2e.config.ts:/app/apps/bot/vitest.e2e.config.ts:ro
      # Mount .env file for smoke tests
      - ../.env:/app/.env:ro
      # Preserve container node_modules
      - /app/node_modules
      - /app/apps/bot/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
      target: dev
    container_name: fightrise-web
    environment:
      DATABASE_URL: postgresql://fightrise:${DB_PASSWORD:-devpassword}@postgres:5432/fightrise
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:4000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-dev-secret-change-in-production}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}
      PORT: 4000
    ports:
      - "4000:4000"
    volumes:
      # Mount source code for hot-reload
      - ../apps/web/src:/app/apps/web/src:ro
      - ../apps/web/app:/app/apps/web/app:ro
      - ../apps/web/public:/app/apps/web/public:ro
      - ../apps/web/components:/app/apps/web/components:ro
      - ../apps/web/lib:/app/apps/web/lib:ro
      - ../apps/web/__tests__:/app/apps/web/__tests__:ro
      - ../apps/web/vitest.config.ts:/app/apps/web/vitest.config.ts:ro
      - ../apps/web/vitest.setup.ts:/app/apps/web/vitest.setup.ts:ro
      - ../apps/web/.eslintrc.json:/app/apps/web/.eslintrc.json:ro
      - ../packages/shared/src:/app/packages/shared/src:ro
      - ../packages/ui/src:/app/packages/ui/src:ro
      - ../packages/ui/vitest.config.ts:/app/packages/ui/vitest.config.ts:ro
      - ../packages/ui/vitest.setup.ts:/app/packages/ui/vitest.setup.ts:ro
      - ../packages/database/src:/app/packages/database/src:ro
      # Preserve container node_modules
      - /app/node_modules
      - /app/apps/web/node_modules
      - /app/apps/web/.next
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===================
  # Development Tools
  # ===================

  # Cloudflare Tunnel for OAuth development
  # Requires prior setup:
  #   1. cloudflared tunnel login
  #   2. cloudflared tunnel create fightrise-dev
  #   3. cp docker/cloudflared-config.yml.example docker/cloudflared-config.yml
  #   4. Edit docker/cloudflared-config.yml with your tunnel UUID and domain
  # See docs/TUNNEL_SETUP.md for details
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: fightrise-tunnel
    profiles:
      - tunnel
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      # Mount tunnel credentials from home directory
      - ${HOME}/.cloudflared:/home/nonroot/.cloudflared:ro
      # Mount docker-specific config from project
      - ./cloudflared-config.yml:/etc/cloudflared/config.yml:ro
    depends_on:
      - web
    restart: unless-stopped

  # Database admin UI (optional)
  # Access at http://localhost:5050
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: fightrise-pgadmin
    profiles:
      - tools
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@fightrise.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres

  # Redis admin UI (optional)
  # Access at http://localhost:8081
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: fightrise-redis-commander
    profiles:
      - tools
    environment:
      REDIS_HOSTS: local:redis:6379
    ports:
      - "8081:8081"
    depends_on:
      - redis

volumes:
  postgres_data:
  redis_data:
  pgadmin_data:
